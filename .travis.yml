language: nodejs
services:
  - docker

cache:
  apt: true
  directories:
    - $HOME/.docker

before_install:
  - if [[ -e ~/.docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
  - docker build -t nomjs/public-website .

script:
  - docker run --rm -it -v $(pwd):/opt/nomjs/public-website -w /opt/nomjs/public-website nomjs/public-website gulp dist

after_success:
  mkdir -p ~/.docker; docker save nomjs/public-website > ~/.docker/image.tar

deploy:
  provider: azure_web_apps
  on: master
